<html>
	<head>
		<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
		<script src="js/value.js"></script>
		<script src="js/parser.js"></script>
		<script src="js/eval.js"></script>
		<script>
		function parseIt() {
			var text = $("#input-text").val();
			console.log(parseAll(text));
		}
		function runIt() {
			var text = $("#input-text").val();
			var results = $("#results");
			var asts = parseAll(text);
			for (var i = 0; i < asts.length; ++i) {
				var result = resultDiv(printAst(asts[i]), asString(rippleEval(asts[i])));
				results.prepend(result);
			}
			updateDefines();
		}
		function resultDiv(expr, res) {
			var input = $("<div></div>")
				.addClass("input-expr")
				.text(expr);
			var output = $("<div></div>")
				.addClass("output-value")
				.text(res);
			var result = $("<div></div>")
				.addClass("result")
				.append(input)
				.append(output)
				.click(function () {
					$("#input-text").val(expr);
				});
			return result;
		}
		function updateDefines() {
			var definesDiv = $("#defines").empty();

			for (var key in defines) {
				if (defines.hasOwnProperty(key) && ! defines[key].isPrimitive) {
					definesDiv.append(defineDiv(key, asString(defines[key])));
				}
			}
		}
		function defineDiv(name, value) {
			var nmDiv = $("<div></div>").addClass("define-name").text(name);
			var valDiv = $("<div></div>").addClass("define-value").text(value);
			var define = $("<div></div>").addClass("define").append(nmDiv).append(valDiv);
			return define;
		}
		$(function () {
			$("#input-text").keydown(function (e) {
				if (e.ctrlKey) {
					switch (e.keyCode) {
						case 13: // Enter
							runIt();
							break;
						case 46: // Delete
							$("#input-text").val("");
							break;
					}
				}
			});
		});
		function buildIt() {
			var text = $("#input-text").val();
			var asts = parseAll(text);
			var artifact = $("#artifact");
			artifact.empty();
			if (asts.length > 0) {
				var ast = asts[0];
				atomCount = 0;
				artifact.append($(build(ast, 0, atomCount)));
			}
		}
		var atomCount = 0;
		function build(ast, depth) {

			if (isCombo(ast)) {
				var d = buildDiv("combo combo-" + (depth % 4));

				for (var i = 0; i < ast.length; ++i) {
					d.appendChild(build(ast[i], depth + 1));
				}

				return d;
			}

			atomCount++;
			var b = buildDiv("atom atom-" + (atomCount % 4));
			b.innerHTML = printAst(ast);
			return b;
		}
		function buildDiv(className) {
			var d = document.createElement("div");
			if (className) {
				d.className = className;
			}
			return d;
		}
		function isCombo(ast) {
			return Object.prototype.toString.call(ast) === "[object Array]";
		}
		</script>
		<style>
			body {
				font-family: 'Source Code Pro', 'Consolas', 'Courier New', monospace;
				font-size: 12px;
			}
			#results, #defines {
				float: left;
				width: 40%;
			}
			.result, .define {
				border-radius: 0.5em;
				margin: 0.5em;
			}
			.result {
				background-color: #eeeeff;
				border: 1px solid #0000ff;
			}
			.result .input-expr, .result .output-value {
				padding: 0.5em;
			}
			.result .input-expr {
				border-bottom: 1px solid #0000ff;
			}
			.define {
				background-color: #eeffee;
				border: 1px solid #00ff00;
			}
			.define .define-name, .define .define-value {
				padding: 0.5em;
			}
			.define .define-name {
				border-bottom: 1px solid #00ff00;
			}
			.clear {
				clear: both;
			}
			#artifact {
				clear: both;
				width: 24em;
			}
			.combo {
				padding-left: 1em;
			}
			.combo-0 {
				background: #ffdddd;
			}
			.combo-1 {
				background: #ffcccc;
			}
			.combo-2 {
				background: #ffbbbb;
			}
			.combo-3 {
				background: #ffaaaa;
			}
			.atom {
				padding: 0.1em;
				margin-bottom: 0.1em;
			}
			.atom-0 {
				border-bottom: 1px solid #ff0000;
			}
			.atom-1 {
				border-bottom: 1px solid #00ff00;
			}
			.atom-2 {
				border-bottom: 1px solid #0000ff;
			}
			.atom-3 {
				border-bottom: 1px solid #00ffff;
			}
		</style>
	</head>
	<body>
		<textarea id="input-text" rows="4" cols="50">(define square (function (x) (* x x)))</textarea>
		<button id="parse-button" onclick="parseIt();">Parse</button>
		<button id="run-button" onclick="runIt();">Run</button>
		<button id="build-button" onclick="buildIt();">Build</button>
		<div class="clear"></div>
		<div id="results"></div>
		<div id="defines"></div>
		<div id="artifact"></div>
	</body>
</html>