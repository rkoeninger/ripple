<html>
	<head>
		<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
		<link href='style.css' rel='stylesheet' type='text/css'>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
		<script src="js/ripple.js"></script>
		<script src="js/ui.js"></script>
		<script>
		function parseIt() {
			var text = $("#input-text").val();
			console.log(ripple.parseAllText(text));
		}
		function runIt() {
			var text = $("#input-text").val();
			var results = $("#results");
			var asts = ripple.parseAllText(text);
			for (var i = 0; i < asts.length; ++i) {
				var result;
				try {
					result = resultDiv(ripple.formatAst(asts[i]), ripple.formatAst(ripple.rippleEval(asts[i])));
				} catch (e) {
					result = errorDiv(ripple.formatAst(asts[i]), e.toString());
				}
				results.prepend(result);
			}
			updateDefines();
		}
		function resultDiv(expr, res) {
			var input = $("<div></div>")
				.addClass("input-expr")
				.text(expr);
			var output = $("<div></div>")
				.addClass("output-value")
				.text(res);
			var result = $("<div></div>")
				.addClass("result")
				.append(input)
				.append(output)
				.click(function () {
					$("#input-text").val(expr);
				});
			return result;
		}
		function errorDiv(expr, res) {
			var input = $("<div></div>")
				.addClass("input-expr")
				.text(expr);
			var output = $("<div></div>")
				.addClass("error-message")
				.text(res);
			var result = $("<div></div>")
				.addClass("error-result")
				.append(input)
				.append(output)
				.click(function () {
					$("#input-text").val(expr);
				});
			return result;
		}
		function updateDefines() {
			var definesDiv = $("#defines").empty();

			for (var key in ripple.defines) {
				if (ripple.defines.hasOwnProperty(key) && ! (ripple.defines[key] instanceof ripple.RipPrimitive)) {
					definesDiv.append(defineDiv(key, ripple.formatAst(ripple.defines[key])));
				}
			}
		}
		function defineDiv(name, value) {
			var nmDiv = $("<div></div>").addClass("define-name").text(name);
			var valDiv = $("<div></div>").addClass("define-value").text(value);
			var define = $("<div></div>").addClass("define").append(nmDiv).append(valDiv);
			return define;
		}
		$(function () {
			$("#input-text").keydown(function (e) {
				if (e.ctrlKey) {
					switch (e.keyCode) {
						case 13: // Enter
							runIt();
							break;
						case 46: // Delete
							$("#input-text").val("");
							break;
					}
				}
			});
		});
		function buildIt() {
			var text = $("#input-text").val();
			var asts = ripple.parseAllText(text);
			var artifact = $("#artifact");
			artifact.empty();
			if (asts.length > 0) {
				var ast = asts[0];
				atomCount = 0;
				artifact.append($(build(ast, 0, atomCount)));
			}
		}
		var atomCount = 0;
		function build(ast, depth) {

			if (isCombo(ast)) {
				var d = buildDiv("combo combo-" + (depth % 4));

				for (var i = 0; i < ast.length; ++i) {
					d.appendChild(build(ast[i], depth + 1));
				}

				return d;
			}

			atomCount++;
			var b = buildDiv("atom atom-" + (atomCount % 4));
			b.innerHTML = ripple.formatAst(ast);
			return b;
		}
		function buildDiv(className) {
			var d = document.createElement("div");
			if (className) {
				d.className = className;
			}
			return d;
		}
		function isCombo(ast) {
			return Object.prototype.toString.call(ast) === "[object Array]";
		}
		</script>
	</head>
	<body>
		<textarea id="input-text" rows="4" cols="50">(define say (function (x) (function () (log x))))

(say "hello")</textarea>
		<button id="parse-button" onclick="parseIt();">Parse</button>
		<button id="run-button" onclick="runIt();">Run</button>
		<button id="build-button" onclick="buildIt();">Build</button>
		<div class="clear"></div>
		<div id="results"></div>
		<div id="defines"></div>
		<div id="artifact"></div>
	</body>
</html>